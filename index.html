<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Downloader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex items-center justify-center transition-colors duration-300">
  <div class="bg-white dark:bg-gray-800 shadow-lg rounded-2xl p-6 w-full max-w-md text-center transition-colors duration-300">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Media Downloader</h1>
      <button id="toggleTheme" class="px-3 py-1 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">🌙</button>
    </div>
    <input id="url" type="url" placeholder="Paste your link here..." class="w-full px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 dark:bg-gray-700 dark:text-white">
    <button id="downloadBtn" class="w-full py-3 rounded-xl bg-blue-600 text-white font-semibold disabled:opacity-50">Download</button>

    <div id="status" class="mt-4 text-sm text-gray-600 dark:text-gray-300"></div>
    <div id="preview" class="mt-4 hidden">
      <h2 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">Preview</h2>
      <div id="mediaContainer" class="rounded-xl overflow-hidden"></div>
      <a id="downloadLink" href="#" target="_blank" class="mt-4 inline-block bg-green-600 text-white px-4 py-2 rounded-xl font-semibold">Download Now</a>
    </div>
  </div>

  <script>
    const PLATFORM_PATTERNS = {
      reel: /instagram\.com\/reel/i,
      igpost: /instagram\.com\/p\//i,
      tiktok: /tiktok\.com\//i,
      snap: /snapchat\.com/i,
      spotify: /spotify\.com/i,
      thread: /threads\.net/i,
      yt: /(youtube\.com|youtu\.be)/i,
      pint: /pinterest\.(com|in)/i,
      x: /(twitter\.com|x\.com)/i,
      fb: /facebook\.com/i
    };

    function detectPlatform(url) {
      for (const [platform, regex] of Object.entries(PLATFORM_PATTERNS)) {
        if (regex.test(url)) return platform;
      }
      return null;
    }

    async function fetchMedia(url, platform) {
      const apiURL = `/api/proxy?platform=${platform}&url=${encodeURIComponent(url)}`;
      document.getElementById('status').textContent = 'Fetching media...';
      try {
        const res = await fetch(apiURL);
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        const link = data.video_link || data.audio_link;
        if (!link) throw new Error('No downloadable media found');
        showPreview(link);
        document.getElementById('status').textContent = '';
      } catch (err) {
        document.getElementById('status').textContent = err.message;
        document.getElementById('preview').classList.add('hidden');
      }
    }

    function showPreview(url) {
      const container = document.getElementById('mediaContainer');
      container.innerHTML = '';
      if (/\.(mp4|webm|m3u8)(\?|$)/i.test(url)) {
        const v = document.createElement('video');
        v.src = url;
        v.controls = true;
        v.className = 'w-full';
        container.appendChild(v);
      } else if (/\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(url)) {
        const img = document.createElement('img');
        img.src = url;
        img.className = 'w-full';
        container.appendChild(img);
      } else if (/\.(mp3|m4a|aac|ogg|wav)(\?|$)/i.test(url)) {
        const a = document.createElement('audio');
        a.src = url;
        a.controls = true;
        a.className = 'w-full';
        container.appendChild(a);
      } else {
        container.textContent = 'Media found but preview unavailable.';
      }
      const dl = document.getElementById('downloadLink');
      dl.href = url;
      document.getElementById('preview').classList.remove('hidden');
    }

    function autoFetchIfValid() {
      const raw = document.getElementById('url').value.trim();
      if (!raw) return;
      const platform = detectPlatform(raw);
      if (platform) fetchMedia(raw, platform);
    }

    document.getElementById('downloadBtn').addEventListener('click', () => {
      const raw = document.getElementById('url').value.trim();
      if (!raw) return;
      const platform = detectPlatform(raw);
      if (!platform) {
        document.getElementById('status').textContent = 'Unsupported or invalid link';
        return;
      }
      fetchMedia(raw, platform);
    });

    document.getElementById('url').addEventListener('paste', () => {
      setTimeout(autoFetchIfValid, 100);
    });

    document.getElementById('toggleTheme').addEventListener('click', () => {
      document.body.classList.toggle('dark');
      document.getElementById('toggleTheme').textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
    });
  </script>
</body>
</html>
